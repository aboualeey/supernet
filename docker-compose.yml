version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: vpn_postgres
    restart: always
    environment:
      POSTGRES_USER: vpn_user
      POSTGRES_PASSWORD: vpn_password
      POSTGRES_DB: vpn_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  # Adminer for easy DB management (Optional but helpful)
  adminer:
    image: adminer
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - postgres

  # Mock WireGuard Service (for development without Linux privileges)
  # In production, this would be the actual WireGuard container or the host
  wireguard-mock:
    image: alpine:latest
    container_name: wg_mock
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    command: sh -c "mkdir -p /etc/wireguard && touch /etc/wireguard/wg0.conf && tail -f /dev/null"
    volumes:
      - ./wireguard_config:/etc/wireguard

  backend:
    build: ./backend
    restart: always
    ports:
      - "3000:3000"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=vpn_db
      - POSTGRES_USER=vpn_user
      - POSTGRES_PASSWORD=vpn_password
      - JWT_SECRET=super_secret_jwt_key_please_change
      - ENCRYPTION_KEY=super_secret_key_must_be_32_bytes_long!!
    depends_on:
      - postgres
    volumes:
      - ./backend:/app
      - /app/node_modules

  frontend:
    build: ./frontend
    restart: always
    ports:
      - "3001:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules

volumes:
  postgres_data:
